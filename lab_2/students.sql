CREATE SEQUENCE PASS_SEQ START WITH 1;

CREATE TABLE PASSING (
    ID                       INTEGER DEFAULT PASS_SEQ.NEXTVAL NOT NULL,
    DATE_EXAM                DATE NOT NULL,
    MARK                     INTEGER NOT NULL,
    STUDENT_NUMBER_OF_BOOK   INTEGER NOT NULL,
    SUBJECT_NAME             VARCHAR2(40) NOT NULL,
    
    CONSTRAINT PASSING_PK PRIMARY KEY ( ID ),
    CONSTRAINT CHECK_MARK CHECK(MARK BETWEEN 2 AND 10)
);

CREATE SEQUENCE STUDENT_SEQ START WITH 1;

CREATE TABLE STUDENT(
    NUMBER_OF_BOOK    INTEGER DEFAULT STUDENT_SEQ.NEXTVAL NOT NULL,
    FIRST_NAME        VARCHAR2(20) NOT NULL,
    LAST_NAME         VARCHAR2(30) NOT NULL,
    SEMESTER_NUMBER   INTEGER NOT NULL,
    
    CONSTRAINT NUMBER_OF_BOOK_PK PRIMARY KEY ( NUMBER_OF_BOOK )
);

CREATE TABLE SEMESTER(
    NUMBER_SEMESTER   INTEGER NOT NULL,
    DESCRIPTION       VARCHAR2(10) NOT NULL,
    
    CONSTRAINT SEMESTER_PK PRIMARY KEY(NUMBER_SEMESTER),
    CONSTRAINT CHECK_NUMBER_SEMESTER CHECK(NUMBER_SEMESTER BETWEEN 1 AND 8)
);

CREATE TABLE SUBJECT(
    NAME    VARCHAR2(40) NOT NULL,
    HOURS   INTEGER NOT NULL,
    
    CONSTRAINT SUBJECT_PK PRIMARY KEY (NAME),
    CONSTRAINT HOURS_CHECK CHECK(HOURS >= 0)
);

CREATE TABLE REPORT(
    NUMBER_REPORT     INTEGER NOT NULL,
    DESCRIPTION      VARCHAR2(15) NOT NULL,  -- ?????/???????/??? ??????????
    
    CONSTRAINT REPORT_PK PRIMARY KEY (NUMBER_REPORT),
    CONSTRAINT NUMBER_REPORT_CHECK CHECK( NUMBER_REPORT BETWEEN 1 AND 3)
);

CREATE TABLE SUBJECT_SEMESTER (
    SUBJECT_NAME      VARCHAR2(40) NOT NULL,
    SEMESTER_NUMBER   INTEGER NOT NULL,
    
    CONSTRAINT SUBJECT_SEMESTER_PK PRIMARY KEY (SUBJECT_NAME, SEMESTER_NUMBER)
);

CREATE TABLE REPORT_SUBJECT (
    REPORT_NUMBER   INTEGER NOT NULL,
    SUBJECT_NAME    VARCHAR2(40) NOT NULL,
    
    CONSTRAINT REPORT_SUBJECT_PK PRIMARY KEY(REPORT_NUMBER, SUBJECT_NAME)
);

CREATE INDEX  "PASSING_IDX" ON  "PASSING" ("STUDENT_NUMBER_OF_BOOK");


ALTER TABLE PASSING
    ADD CONSTRAINT PASSING_STUDENT_FK FOREIGN KEY ( STUDENT_NUMBER_OF_BOOK )
        REFERENCES STUDENT ( NUMBER_OF_BOOK ) ON DELETE CASCADE;

ALTER TABLE PASSING
    ADD CONSTRAINT PASSING_SUBJECT_FK FOREIGN KEY ( SUBJECT_NAME )
        REFERENCES SUBJECT ( NAME ) ON DELETE CASCADE;

ALTER TABLE REPORT_SUBJECT
    ADD CONSTRAINT REPORT_SUBJECT_REPORT_NUMBER_FK FOREIGN KEY ( REPORT_NUMBER_REPORT )
        REFERENCES REPORT ( NUMBER_REPORT );

ALTER TABLE REPORT_SUBJECT
    ADD CONSTRAINT REPORT_SUBJECT_SUBJECT_NAME_FK FOREIGN KEY ( SUBJECT_NAME )
        REFERENCES SUBJECT ( NAME );

ALTER TABLE STUDENT
    ADD CONSTRAINT STUDENT_SEMESTER_FK FOREIGN KEY ( SEMESTER_NUMBER )
        REFERENCES SEMESTER ( NUMBER_SEMESTER )ON DELETE SET NULL;

ALTER TABLE SUBJECT_SEMESTER
    ADD CONSTRAINT SUBJECT_SEMESTER_SEMESTER_NUMBER_FK FOREIGN KEY (SEMESTER_NUMBER  )
        REFERENCES SEMESTER ( NUMBER_SEMESTER );

ALTER TABLE SUBJECT_SEMESTER
    ADD CONSTRAINT SUBJECT_SEMESTER_SUBJECT_NAME_FK FOREIGN KEY ( SUBJECT_NAME )
        REFERENCES SUBJECT ( NAME );
        

INSERT INTO REPORT(NUMBER_REPORT, DESCRIPTION) VALUES(1, 'Test');
INSERT INTO REPORT(NUMBER_REPORT, DESCRIPTION) VALUES(2, 'Exam');
INSERT INTO REPORT(NUMBER_REPORT, DESCRIPTION) VALUES(3, 'No report');

--SELECT * FROM REPORT;

INSERT INTO SUBJECT(NAME, HOURS) VALUES('Criptography', 126);
INSERT INTO SUBJECT(NAME, HOURS) VALUES('Programming', 120);
INSERT INTO SUBJECT(NAME, HOURS) VALUES('Math', 140);
INSERT INTO SUBJECT(NAME, HOURS) VALUES('ISO', 60);

--SELECT * FROM SUBJECT;

INSERT INTO SEMESTER(NUMBER_SEMESTER, DESCRIPTION) VALUES(1, 'WINTER');
INSERT INTO SEMESTER(NUMBER_SEMESTER, DESCRIPTION) VALUES(2, 'SUMMER');
INSERT INTO SEMESTER(NUMBER_SEMESTER, DESCRIPTION) VALUES(3, 'WINTER');
INSERT INTO SEMESTER(NUMBER_SEMESTER, DESCRIPTION) VALUES(4, 'SUMMER');

--SELECT * FROM SEMESTER;

INSERT INTO STUDENT(FIRST_NAME, LAST_NAME, SEMESTER_NUMBER) VALUES( 'Alex', 'Wong', 1);
INSERT INTO STUDENT(FIRST_NAME, LAST_NAME, SEMESTER_NUMBER) VALUES( 'Jim', 'Smith', 1);
INSERT INTO STUDENT(FIRST_NAME, LAST_NAME, SEMESTER_NUMBER) VALUES( 'Bob', 'Andersen', 1);
INSERT INTO STUDENT(FIRST_NAME, LAST_NAME, SEMESTER_NUMBER) VALUES( 'Alex', 'Smith', 1);

--SELECT * FROM STUDENT;

INSERT INTO PASSING(DATE_EXAM, MARK, STUDENT_NUMBER_OF_BOOK, SUBJECT_NAME) 
    VALUES( to_date('14-03-2018', 'dd-mm-yyyy'), 6, 1, 'Math');
INSERT INTO PASSING(DATE_EXAM, MARK, STUDENT_NUMBER_OF_BOOK, SUBJECT_NAME) 
    VALUES( to_date('14-03-2018', 'dd-mm-yyyy'), 6, 2, 'Programming');
INSERT INTO PASSING(DATE_EXAM, MARK, STUDENT_NUMBER_OF_BOOK, SUBJECT_NAME) 
    VALUES( to_date('16-03-2018', 'dd-mm-yyyy'), 8, 1, 'Criptography');

--SELECT * FROM PASSING;

INSERT INTO SUBJECT_SEMESTER(SUBJECT_NAME, SEMESTER_NUMBER) VALUES('Criptography', 2);
INSERT INTO SUBJECT_SEMESTER(SUBJECT_NAME, SEMESTER_NUMBER) VALUES('Criptography', 3);
INSERT INTO SUBJECT_SEMESTER(SUBJECT_NAME, SEMESTER_NUMBER) VALUES('Programming', 2);
INSERT INTO SUBJECT_SEMESTER(SUBJECT_NAME, SEMESTER_NUMBER) VALUES('Math', 1);
INSERT INTO SUBJECT_SEMESTER(SUBJECT_NAME, SEMESTER_NUMBER) VALUES('ISO', 2);

--SELECT * FROM SUBJECT_SEMESTER;

INSERT INTO REPORT_SUBJECT(REPORT_NUMBER, SUBJECT_NAME) VALUES(2,'Criptography');
INSERT INTO REPORT_SUBJECT(REPORT_NUMBER, SUBJECT_NAME) VALUES(1,'Programming');
INSERT INTO REPORT_SUBJECT(REPORT_NUMBER, SUBJECT_NAME) VALUES(1,'Math');
INSERT INTO REPORT_SUBJECT(REPORT_NUMBER, SUBJECT_NAME) VALUES(2,'Math');
INSERT INTO REPORT_SUBJECT(REPORT_NUMBER, SUBJECT_NAME) VALUES(3,'ISO');

--SELECT * FROM REPORT_SUBJECT;

